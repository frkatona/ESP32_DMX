<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESP32 DMX Controller</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #eee;
    }

    body {
      margin: 0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    h1 {
      font-size: 1.5rem;
      margin: 0.5rem 0 0.25rem;
      text-align: center;
    }

    .subtitle {
      font-size: 0.85rem;
      opacity: 0.7;
      text-align: center;
      margin-bottom: 1rem;
    }

    .card {
      background: #1d1d1d;
      border-radius: 12px;
      padding: 1rem;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    }

    .channels {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .channel-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 0.4rem;
    }

    @media (min-width: 600px) {
      .channel-row {
        grid-template-columns: 120px minmax(0, 1fr) 60px;
        align-items: center;
      }
    }

    .ch-label {
      font-size: 0.9rem;
      font-weight: 600;
      white-space: nowrap;
    }

    input[type="range"] {
      width: 100%;
    }

    .value-box {
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-size: 0.9rem;
      padding: 0.1rem 0.3rem;
      background: #222;
      border-radius: 6px;
      border: 1px solid #333;
    }

    .footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.4rem 0.9rem;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      background: #3a6df0;
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    .status {
      font-size: 0.75rem;
      opacity: 0.75;
    }

    .status.ok {
      color: #7dff8b;
    }

    .status.err {
      color: #ff7d7d;
    }
  </style>
</head>
<body>
  <h1>ESP32 DMX Controller</h1>
  <div class="subtitle">Adjust DMX channels 1–9 in real time</div>

  <div class="card">
    <div class="channels" id="channels"></div>

    <div class="footer-row">
      <div>
        <button id="allOffBtn">All Off</button>
        <button id="allFullBtn">All 255</button>
      </div>
      <div class="status" id="status">Idle</div>
    </div>
  </div>

  <script>
    // Describe your DMX channels here (names are just for UI)
    const channelDefs = [
      { ch: 1, label: "Ch 1 — Yaw" }, // 000-255 low yaw to high yaw
      { ch: 2, label: "Ch 2 — Tilt" }, // 000-255 low tilt to high tilt
      { ch: 3, label: "Ch 3 — Color Wheel" }, // 0-71 Gobo, 72-139 Static Pair, 140+ Auto
      { ch: 4, label: "Ch 4 — Gobo Wheel" }, //000-007 open white, 000-015 gobo 1, 016-023 gobo 2, 024-031 gobo 3, 032-039 gobo 4, 040-047 gobo 5, 048-055 gobo 6, 056-063 gobo 7, 064-071 white shake, 072-079 shake 1, 080-087 shake 2, 088-095 shake 3, 096-103 shake 4, 104-111 shake 5, 112-119 shake 6, 120-127 shake 7, 128-135 auto gobo slow to fast
      { ch: 5, label: "Ch 5 — Strobe" }, // 000-009 non functional, 010-249 strobe slow to fast, 250-255 strobe off
      { ch: 6, label: "Ch 6 — Master Dimmer" }, // 000-009 off, 010-255 brightness low to high
      { ch: 7, label: "Ch 7 — Pan/Tilt Speed" }, // 000-255 fast to slow
      { ch: 8, label: "Ch 8 — Auto Mode" }, // 000-135 inactive, 135-159 Auto, 160-184 sound mode 3, 185-209 sound mode 2, 210-234 sound mode 1, 235-255 sound mode 0
      { ch: 9, label: "Ch 9 — Reset" }, // 000-249 no reset, 250-255 reset
    ];

    const channelsContainer = document.getElementById("channels");
    const statusEl = document.getElementById("status");
    const allOffBtn = document.getElementById("allOffBtn");
    const allFullBtn = document.getElementById("allFullBtn");

    function setStatus(text, ok = true) {
      statusEl.textContent = text;
      statusEl.classList.toggle("ok", ok);
      statusEl.classList.toggle("err", !ok);
    }

    function sendDMXValue(ch, value) {
      // Basic GET /set?ch=<ch>&val=<value>
      fetch(`/set?ch=${encodeURIComponent(ch)}&val=${encodeURIComponent(value)}`)
        .then((res) => {
          if (!res.ok) throw new Error(res.statusText);
          setStatus(`Set ch ${ch} → ${value}`, true);
        })
        .catch((err) => {
          console.error(err);
          setStatus(`Error sending ch ${ch}`, false);
        });
    }

    function createChannelRow(def) {
      const row = document.createElement("div");
      row.className = "channel-row";

      const label = document.createElement("div");
      label.className = "ch-label";
      label.textContent = def.label;

      const slider = document.createElement("input");
      slider.type = "range";
      slider.min = "0";
      slider.max = "255";
      slider.value = "0";
      slider.step = "1";

      const valueBox = document.createElement("div");
      valueBox.className = "value-box";
      valueBox.textContent = "0";

      // Live update value label
      slider.addEventListener("input", () => {
        valueBox.textContent = slider.value;
      });

      // Send on change / after drag
      slider.addEventListener("change", () => {
        const v = Number(slider.value) || 0;
        sendDMXValue(def.ch, v);
      });

      row.appendChild(label);
      row.appendChild(slider);
      row.appendChild(valueBox);

      def.slider = slider;
      def.valueBox = valueBox;

      return row;
    }

    // Build UI
    channelDefs.forEach((def) => {
      const row = createChannelRow(def);
      channelsContainer.appendChild(row);
    });

    // Bulk controls
    allOffBtn.addEventListener("click", () => {
      channelDefs.forEach((def) => {
        def.slider.value = 0;
        def.valueBox.textContent = "0";
        sendDMXValue(def.ch, 0);
      });
    });

    allFullBtn.addEventListener("click", () => {
      channelDefs.forEach((def) => {
        def.slider.value = 255;
        def.valueBox.textContent = "255";
        sendDMXValue(def.ch, 255);
      });
    });

    // Optional: sync UI from /state endpoint if you implement it on ESP32
    function fetchState() {
      fetch("/state")
        .then((res) => res.json())
        .then((json) => {
          // Expecting something like: { "1": 0, "2": 128, ... }
          channelDefs.forEach((def) => {
            const v = Number(json[def.ch]) || 0;
            def.slider.value = v;
            def.valueBox.textContent = v;
          });
          setStatus("Synced from ESP32", true);
        })
        .catch(() => {
          // It's okay if /state isn't implemented
        });
    }

    // Try a sync shortly after load
    setTimeout(fetchState, 1000);
  </script>
</body>
</html>
